<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© â€” Ø§Ù„ÙˆÙØ±Ù’Ø¯Ù</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #14532d 0%, #166534 50%, #15803d 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      direction: rtl;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px 32px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }
    .logo {
      font-size: 42px;
      margin-bottom: 8px;
    }
    .app-name {
      font-size: 22px;
      font-weight: 800;
      color: #15803d;
      margin-bottom: 6px;
    }
    h2 {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 6px;
    }
    .subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 28px;
    }
    .form-group {
      margin-bottom: 16px;
      text-align: right;
    }
    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }
    input[type="password"] {
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid #d1d5db;
      border-radius: 10px;
      font-size: 15px;
      direction: ltr;
      text-align: left;
      outline: none;
      transition: border-color 0.2s;
    }
    input[type="password"]:focus {
      border-color: #16a34a;
    }
    .btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #16a34a, #15803d);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
      transition: opacity 0.2s;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .err-text {
      color: #dc2626;
      font-size: 13px;
      margin-top: 10px;
      min-height: 18px;
    }
    .success-box {
      display: none;
      background: #f0fdf4;
      border: 1.5px solid #bbf7d0;
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
    }
    .success-box p {
      color: #15803d;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .success-box a {
      color: #16a34a;
      font-weight: 700;
      text-decoration: none;
    }
    .error-box {
      display: none;
      background: #fef2f2;
      border: 1.5px solid #fecaca;
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
    }
    .error-box p {
      color: #dc2626;
      font-size: 14px;
      margin-bottom: 12px;
    }
    .error-box a {
      color: #16a34a;
      font-weight: 700;
      text-decoration: none;
    }
    #form-section { display: none; }
    #loading { color: #666; font-size: 15px; padding: 20px 0; }
  </style>
</head>
<body>
<div class="container">
  <div class="logo">ğŸ“–</div>
  <div class="app-name">Ø§Ù„ÙˆÙØ±Ù’Ø¯Ù Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ</div>

  <div id="loading">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...</div>

  <!-- Error state (link expired/invalid) -->
  <div class="error-box" id="error-box">
    <h2>Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­</h2>
    <p id="error-msg">Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø£Ùˆ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯.</p>
    <a href="/">â† Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯</a>
  </div>

  <!-- Password reset form -->
  <div id="form-section">
    <h2>ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</h2>
    <p class="subtitle">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§</p>

    <div class="form-group">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
      <input type="password" id="new-password" placeholder="6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„" />
    </div>
    <div class="form-group">
      <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input type="password" id="confirm-password" placeholder="Ø£Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    </div>
    <div class="err-text" id="err-text"></div>
    <button class="btn" id="submit-btn" onclick="submitNewPassword()">Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± â†</button>
  </div>

  <!-- Success state -->
  <div class="success-box" id="success-box">
    <p>âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!</p>
    <a href="/">â† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†</a>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://hiatftvcsheggxbrfbek.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpYXRmdHZjc2hlZ2d4YnJmYmVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODk2NDIsImV4cCI6MjA4NjY2NTY0Mn0.Xa627AYcsSX37vHGCgx-AR62Fc1-O4jIUr_-o4b1oeg';

  const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function showError(msg) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('form-section').style.display = 'none';
    const box = document.getElementById('error-box');
    box.style.display = 'block';
    if (msg) document.getElementById('error-msg').textContent = msg;
  }

  function showForm() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('form-section').style.display = 'block';
  }

  // Parse hash fragment
  function parseHash() {
    const hash = window.location.hash.substring(1);
    const params = {};
    hash.split('&').forEach(part => {
      const [k, v] = part.split('=');
      if (k) params[k] = decodeURIComponent(v || '');
    });
    return params;
  }

  async function init() {
    const params = parseHash();

    // Handle error from Supabase (e.g. otp_expired)
    if (params.error) {
      if (params.error_code === 'otp_expired') {
        showError('Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© ÙˆØ·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯.');
      } else {
        showError(params.error_description || 'Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
      }
      return;
    }

    // If we have an access_token with type=recovery, set the session
    if (params.access_token && params.type === 'recovery') {
      const { error } = await db.auth.setSession({
        access_token: params.access_token,
        refresh_token: params.refresh_token || ''
      });
      if (error) {
        showError('ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯.');
        return;
      }
      showForm();
      return;
    }

    // Check if Supabase already restored a recovery session (PKCE flow)
    db.auth.onAuthStateChange((event, session) => {
      if (event === 'PASSWORD_RECOVERY') {
        showForm();
      }
    });

    // Give it a moment to detect session
    setTimeout(() => {
      const loadingEl = document.getElementById('loading');
      if (loadingEl.style.display !== 'none' && document.getElementById('form-section').style.display === 'none') {
        showError('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯.');
      }
    }, 3000);
  }

  async function submitNewPassword() {
    const pass = document.getElementById('new-password').value;
    const confirm = document.getElementById('confirm-password').value;
    const errEl = document.getElementById('err-text');
    const btn = document.getElementById('submit-btn');

    errEl.textContent = '';

    if (!pass || pass.length < 6) {
      errEl.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
      return;
    }
    if (pass !== confirm) {
      errEl.textContent = 'ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†';
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';

    const { error } = await db.auth.updateUser({ password: pass });

    if (error) {
      errEl.textContent = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
      btn.disabled = false;
      btn.textContent = 'Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± â†';
      return;
    }

    // Sign out so user logs in fresh with new password
    await db.auth.signOut();

    document.getElementById('form-section').style.display = 'none';
    document.getElementById('success-box').style.display = 'block';

    // Auto-redirect after 3 seconds
    setTimeout(() => { window.location.href = '/'; }, 3000);
  }

  init();
</script>
</body>
</html>
