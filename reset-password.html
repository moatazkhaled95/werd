<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© â€” Ø§Ù„ÙˆÙØ±Ù’Ø¯Ù</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
      background: url('bg.jpg') center center / cover no-repeat;
      background-attachment: scroll;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      direction: rtl;
    }
    #app {
      width: 100%;
      max-width: 428px;
      min-height: 100vh;
      background: rgba(0,0,0,0.35);
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Screen Header â”€â”€ */
    .screen-header {
      background: linear-gradient(135deg, #134e4a, #0f766e);
      padding: 56px 24px 24px;
      color: #fff;
      position: relative;
    }
    .screen-header h2 { font-size: 22px; font-weight: 700; }
    .screen-header p  { font-size: 13px; color: #99f6e4; margin-top: 4px; }

    /* â”€â”€ Screen Body â”€â”€ */
    .screen-body {
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex: 1;
      background: #f9fafb;
    }

    /* â”€â”€ Card â”€â”€ */
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* â”€â”€ Form â”€â”€ */
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: #0f766e; }
    .form-group input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      outline: none;
      transition: border-color .2s;
      text-align: left;
      direction: ltr;
      font-family: inherit;
      background: #fff;
    }
    .form-group input[type="password"]:focus { border-color: #0d9488; }

    /* â”€â”€ Button â”€â”€ */
    .btn-primary {
      width: 100%; padding: 14px;
      background: linear-gradient(135deg, #0d9488, #0f766e);
      color: #fff; border: none;
      border-radius: 14px; font-size: 16px;
      font-weight: 700; cursor: pointer;
      transition: opacity .2s; font-family: inherit;
    }
    .btn-primary:hover { opacity: .9; }
    .btn-primary:disabled { opacity: .5; cursor: not-allowed; }

    /* â”€â”€ Error / Auth links â”€â”€ */
    .err-text { font-size: 12px; color: #dc2626; margin-top: 2px; min-height: 16px; }
    .auth-link { text-align: center; font-size: 13px; color: #6b7280; }
    .auth-link a { color: #0d9488; font-weight: 700; cursor: pointer; text-decoration: none; }

    /* â”€â”€ Success / Error boxes â”€â”€ */
    .success-box {
      background: #f0fdf4;
      border: 1.5px solid #bbf7d0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .success-box p { color: #15803d; font-size: 15px; font-weight: 600; margin-bottom: 12px; }
    .error-box {
      background: #fef2f2;
      border: 1.5px solid #fecaca;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .error-box p { color: #dc2626; font-size: 14px; margin-bottom: 12px; }
    .error-box a, .success-box a { color: #0d9488; font-weight: 700; text-decoration: none; }

    /* â”€â”€ Loading spinner â”€â”€ */
    #loading-state {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 12px; padding: 40px 0; color: #6b7280; font-size: 14px;
    }
    .spinner {
      width: 32px; height: 32px;
      border: 3px solid #e5e7eb;
      border-top-color: #0d9488;
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* eye toggle */
    .pass-wrap { position: relative; }
    .pass-wrap input { padding-left: 40px !important; }
    .eye-btn {
      position: absolute; left: 10px; top: 50%;
      transform: translateY(-50%);
      background: none; border: none; cursor: pointer;
      color: #9ca3af; font-size: 16px; padding: 0; line-height: 1;
    }
  </style>
</head>
<body>
<div id="app">
  <div class="screen-header">
    <h2>ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</h2>
    <p>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§</p>
  </div>

  <div class="screen-body">

    <!-- Loading -->
    <div id="loading-state">
      <div class="spinner"></div>
      <span>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...</span>
    </div>

    <!-- Error state (link expired/invalid) -->
    <div class="error-box" id="error-box" style="display:none">
      <p id="error-msg">Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø£Ùˆ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹.</p>
      <a href="/">â† Ø§Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø·Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</a>
    </div>

    <!-- Password form -->
    <div id="form-section" style="display:none; display:none; flex-direction:column; gap:16px">
      <div class="card">
        <div class="form-group">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
          <div class="pass-wrap">
            <input type="password" id="new-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" />
            <button type="button" class="eye-btn" onclick="togglePass('new-password', this)">ğŸ‘</button>
          </div>
        </div>
        <div class="form-group">
          <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <div class="pass-wrap">
            <input type="password" id="confirm-password" placeholder="Ø£Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
            <button type="button" class="eye-btn" onclick="togglePass('confirm-password', this)">ğŸ‘</button>
          </div>
        </div>
        <div class="err-text" id="err-text"></div>
      </div>

      <button class="btn-primary" id="submit-btn" onclick="submitNewPassword()">Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± â†</button>
      <p class="auth-link"><a href="/">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></p>
    </div>

    <!-- Success state -->
    <div class="success-box" id="success-box" style="display:none">
      <p>âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!</p>
      <a href="/">â† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†</a>
    </div>

  </div>
</div>

<script>
  const SUPABASE_URL = 'https://hiatftvcsheggxbrfbek.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpYXRmdHZjc2hlZ2d4YnJmYmVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODk2NDIsImV4cCI6MjA4NjY2NTY0Mn0.Xa627AYcsSX37vHGCgx-AR62Fc1-O4jIUr_-o4b1oeg';
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: false }
  });

  function hide(id) { document.getElementById(id).style.display = 'none'; }
  function show(id, flex) {
    const el = document.getElementById(id);
    el.style.display = flex ? 'flex' : 'block';
  }

  function showError(msg) {
    hide('loading-state');
    hide('form-section');
    show('error-box');
    if (msg) document.getElementById('error-msg').textContent = msg;
  }

  function showForm() {
    hide('loading-state');
    show('form-section', true);
  }

  function togglePass(id, btn) {
    const input = document.getElementById(id);
    if (input.type === 'password') { input.type = 'text'; btn.textContent = 'ğŸ™ˆ'; }
    else { input.type = 'password'; btn.textContent = 'ğŸ‘'; }
  }

  function parseHash() {
    const hash = window.location.hash.substring(1);
    const params = {};
    hash.split('&').forEach(part => {
      const [k, v] = part.split('=');
      if (k) params[k] = decodeURIComponent((v || '').replace(/\+/g, ' '));
    });
    return params;
  }

  async function init() {
    const params = parseHash();

    // Supabase sent an error (e.g. otp_expired)
    if (params.error) {
      const msg = params.error_code === 'otp_expired'
        ? 'Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© ÙˆØ·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯.'
        : (params.error_description || 'Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
      showError(msg);
      return;
    }

    // Token in hash (implicit flow)
    if (params.access_token && params.type === 'recovery') {
      const { error } = await db.auth.setSession({
        access_token: params.access_token,
        refresh_token: params.refresh_token || ''
      });
      if (error) { showError('ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯.'); return; }
      showForm();
      return;
    }

    // PKCE flow â€” listen for PASSWORD_RECOVERY event
    db.auth.onAuthStateChange((event) => {
      if (event === 'PASSWORD_RECOVERY') showForm();
    });

    // Fallback timeout
    setTimeout(() => {
      if (document.getElementById('loading-state').style.display !== 'none') {
        showError('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯.');
      }
    }, 3000);
  }

  async function submitNewPassword() {
    const pass = document.getElementById('new-password').value;
    const confirm = document.getElementById('confirm-password').value;
    const errEl = document.getElementById('err-text');
    const btn = document.getElementById('submit-btn');

    errEl.textContent = '';

    if (!pass || pass.length < 6) {
      errEl.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
      return;
    }
    if (pass !== confirm) {
      errEl.textContent = 'ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†';
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';

    const { error } = await db.auth.updateUser({ password: pass });

    if (error) {
      errEl.textContent = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
      btn.disabled = false;
      btn.textContent = 'Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± â†';
      return;
    }

    await db.auth.signOut();
    hide('form-section');
    show('success-box');
    setTimeout(() => { window.location.href = '/'; }, 3000);
  }

  init();
</script>
</body>
</html>
